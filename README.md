# Лабораторна робота №4  
## Аутентифікація (JWT) для сервісу обліку витрат

---

## Опис

Це продовження попередніх лабораторних робіт (ЛР2–ЛР3) з курсу **“Технології серверного програмного забезпечення”**.  
Проєкт — це Flask REST API для обліку витрат користувачів з використанням **PostgreSQL** та **ORM (SQLAlchemy)**.

У цій лабораторній до проєкту додано:

- реєстрацію та логін користувачів;
- зберігання паролів у вигляді хешів 
- авторизацію за допомогою JWT-токенів;
- захист усіх бізнес-ендпоінтів декоратором `@jwt_required()`.

---

## Мета роботи

> Додати можливість аутентифікації в проєкт.

---

## Завдання

- Навчитись додавати аутентифікацію за допомогою **JWT**.
- Налаштувати видачу та перевірку JWT-токенів у Flask-застосунку.
- Захистити основні ендпоінти так, щоб до них мали доступ тільки авторизовані користувачі.
- Протестувати роботу застосунку за допомогою Postman / Insomnia.

---

## Використані технології

- **Python 3**
- **Flask**
- **Flask-SQLAlchemy** — ORM
- **Flask-Migrate** (Alembic) — міграції БД
- **PostgreSQL** (через Docker)
- **Docker**, **docker-compose**
- **flask-jwt-extended** — робота з JWT
- **passlib** (`pbkdf2_sha256`) — хешування паролів

---

## ORM-моделі

### User

- `id` — первинний ключ  
- `username` — унікальний логін (обовʼязковий)  
- `password` — захешований пароль (`pbkdf2_sha256`)  
- `name` — ім’я користувача  
- `records` — звʼязок one-to-many з витратами користувача  
- `account` — звʼязок one-to-one з рахунком користувача

### Category

- `id`  
- `name` — унікальна назва категорії  
- `records` — записи витрат у цій категорії

### Record (витрата)

- `id`  
- `user_id` → `User`  
- `category_id` → `Category`  
- `created_at` — дата та час створення запису  
- `amount` — сума витрати (Decimal)

### Account (варіант 0 — облік доходів)

- `id`  
- `user_id` → `User` (one-to-one)  
- `balance` — поточний баланс рахунку користувача

При створенні витрати (`POST /record`) сума **автоматично списується** з рахунку користувача.  
Якщо коштів недостатньо — повертається помилка `Insufficient funds on account`.

---

## Налаштування та запуск

### 1. Активація віртуального середовища та встановлення залежностей 

```

python -m venv env

env\Scripts\Activate.ps1

pip install -r requirements.txt
```
### 2. JWT секретний ключ
перед запуском застосунку необхідно встановити змінну середовища:
```
$env:JWT_SECRET_KEY="...."
```
### 3. Запуск бази даних (Docker + PostgreSQL)
```
docker-compose up -d db
```

### 4. Міграції бази даних
```
flask --app app db upgrade
```
### 5. Запуск Flask-застосунку
```
flask --app app run -h 0.0.0.0 -p 8080
```

## Приклад сценарію тестування 

GET /healthcheck — перевірити, що сервіс живий.

POST /user — зареєструвати нового користувача.

POST /login — отримати access_token.

Встановити заголовок Authorization: Bearer <access_token> у всіх подальших запитах.

POST /category — створити категорію витрат (наприклад, "Їжа").

POST /user/1/account/deposit з {"amount": 500} — поповнити рахунок.

POST /record з {"user_id": 1, "category_id": 1, "amount": 200} — створити витрату, перевірити списання з рахунку.

GET /record?user_id=1 — подивитись усі витрати користувача.

GET /user/1/account — перевірити оновлений баланс.
